esphome:
  name: workspace
  on_boot:
    priority: 800
    then:
      - output.set_level:
          id: lcd_backlight
          level: 100%
      - lambda: |-
          id(canvas_index) = 0;
          id(my_display).set_canvas(id(canvas_index));
          id(backlight_level) = 0.4f;
      - script.execute: set_backlight_level

external_components:
  - source:
      type: local
      path: custom_components

esp32:
  board: esp32s3box
  framework:
    type: esp-idf

# Enable logging
logger:
  level: DEBUG
  logs:
    esp-idf: WARN       # 屏蔽 ESP-IDF 的啰嗦 I2C NACK
    main: DEBUG         # 你的 lambda/ESP_LOGD("canvas", ...) 属于 main
    binary_sensor: DEBUG
    touchscreen: DEBUG
    component: DEBUG
    gt911: DEBUG

# Enable Home Assistant API
api:
  password: !secret api_password

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Workspace Fallback Hotspot"
    password: "80vZ4cytFZGz"

captive_portal:

time:
  - platform: homeassistant
    id: ha_time

globals:
  - id: canvas_index
    type: int
    restore_value: no
    initial_value: '0'
  - id: backlight_level
    type: float
    restore_value: no
    initial_value: '0.4'
  - id: swipe_start_y
    type: int
    restore_value: no
    initial_value: '-1'
  - id: swipe_min_y
    type: int
    restore_value: no
    initial_value: '-1'   # 复用为 last_y 记录最新 y
  - id: swipe_base_level
    type: float
    restore_value: no
    initial_value: '-1'

script:
  - id: set_backlight_level
    mode: restart
    then:
      - lambda: |-
          float level = id(backlight_level);
          if (level < 0.0f) level = 0.0f;
          if (level > 1.0f) level = 1.0f;
          id(backlight_level) = level;
          id(lcd_backlight).set_level(level);
          ESP_LOGI("backlight", "Set brightness level=%.3f", level);

i2c:
  - id: i2c_sensors
    sda: 41      # SENSOR 底座 SDA
    scl: 40      # SENSOR 底座 SCL
    scan: true

  # 板载触摸 I2C 总线（ESP-BOX-3: SDA=GPIO8, SCL=GPIO18）
  - id: i2c_touch
    sda: 8
    scl: 18
    # 触摸芯片已确认在此总线上，常规使用时关闭扫描
    scan: false

sensor:
  # ESP32-S3-BOX-3-SENSOR 底座上的 AHT20 温湿度
  - platform: aht10
    variant: AHT20
    i2c_id: i2c_sensors
    temperature:
      id: temperature
      name: "Workspace Temperature"
    humidity:
      id: humidity
      name: "Workspace Humidity"
    update_interval: 1s

  # 股票价格（从 Home Assistant 获取，快手 HK1024）
  - platform: homeassistant
    id: stock_price
    entity_id: sensor.1024_hk

  # 室外温度（来自 Home Assistant 天气实体 weather.forecast_home）
  - platform: homeassistant
    id: outside_temperature
    entity_id: weather.forecast_home
    attribute: temperature

binary_sensor:
  # 24GHz 雷达人体存在检测（AT581x，数字输出接 GPIO21）
  - platform: gpio
    id: radar_presence
    name: "Workspace Presence"
    device_class: occupancy
    pin:
      number: GPIO21
      mode:
        input: true
        pullup: true
    filters:
      - delayed_off: 120s   # 2 分钟无人才判定为离开

  # ESP32-S3-BOX-3 底部圆形 "Home" 触摸按键（GT911 外置按键 index 0）
  - platform: gt911
    id: home_key
    name: "Box3 Home Key"
    index: 0
    on_press:
      - lambda: |-
          id(canvas_index) = (id(canvas_index) + 1) % 3;
          id(my_display).set_canvas(id(canvas_index));
          ESP_LOGD("canvas", "Home pressed, switched to canvas %d", id(canvas_index));
    on_release:
      - logger.log: "Home key RELEASED"

text_sensor:
  # 今日事项
  - platform: homeassistant
    id: calendar_event
    entity_id: calendar.personal

  # 新闻标题
  - platform: homeassistant
    id: news_headline
    # 这里复用为“当前天气预报”，从 Home Assistant 天气实体读取
    # 如果你的天气实体 ID 不同，请把 weather.forecast_home 改成实际的 entity_id
    entity_id: weather.forecast_home

touchscreen:
  - platform: gt911
    id: box3_touch
    i2c_id: i2c_touch
    address: 0x5D
    interrupt_pin: GPIO3       # BSP_LCD_TOUCH_INT
    # reset_pin 可选，GT911 与 LCD 共用复位逻辑，由板级电路处理
    on_update:
      - lambda: |-
          using namespace esphome::touchscreen;
          const float kPixelsPerUnit = 80.0f;   // 调高灵敏度：约 80px 到全亮
          ESP_LOGD("gt911", "on_update: touches=%u", (unsigned) touches.size());
          for (auto &t : touches) {
            ESP_LOGD("gt911", "Touch: id=%d x=%d, y=%d, state=%d", t.id, t.x, t.y, (int)t.state);
            const bool active = (t.state == STATE_PRESSED) || (t.state == STATE_UPDATED);
            if (active) {
              if (id(swipe_start_y) < 0) {
                id(swipe_start_y) = t.y;  // 起点
                id(swipe_base_level) = id(backlight_level);
                id(swipe_min_y) = t.y;  // 作为 last_y 复用
              }
              id(swipe_min_y) = t.y;  // 记录最新位置
              float delta = static_cast<float>(t.y - id(swipe_start_y));  // 上滑为正，下滑为负
              float target = id(swipe_base_level) + delta / kPixelsPerUnit;
              if (target > 1.0f) target = 1.0f;
              if (target < 0.0f) target = 0.0f;
              id(backlight_level) = target;
              id(set_backlight_level).execute();
              ESP_LOGI("backlight", "Swipe (live) -> level=%.3f", id(backlight_level));
            } else {  // state 0 (released) or >=4 (releasing/calibrate)
              id(swipe_start_y) = -1;
              id(swipe_min_y) = -1;
              id(swipe_base_level) = -1;
            }
          }

output:
  - platform: ledc
    id: lcd_backlight
    pin: GPIO47
    frequency: 5000 Hz
    inverted: true

display:
  - platform: box3_lcd
    id: my_display
    temperature: temperature
    humidity: humidity
    radar: radar_presence
    stock: stock_price
    calendar: calendar_event
    news: news_headline
    outdoor_temperature: outside_temperature
    time_id: ha_time

# 颜色定义
color:
  - id: COLOR_BLACK
    hex: "000000"
  - id: COLOR_WHITE
    hex: "FFFFFF"
  - id: COLOR_GRAY
    hex: "808080"
  - id: COLOR_CYAN
    hex: "00FFFF"
  - id: COLOR_ORANGE
    hex: "FFA500"
  - id: COLOR_BLUE
    hex: "0000FF"
  - id: COLOR_GREEN
    hex: "00FF00"
  - id: COLOR_YELLOW
    hex: "FFFF00"
  - id: my_red
    red: 100%
    green: 3%
    blue: 5%
